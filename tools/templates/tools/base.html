{% load static django_htmx %}
<!DOCTYPE html>
<html lang="{{ current_lang|default:'en' }}" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Custom primary color (muted blue) -->
    <style>
        :root,
        [data-bs-theme="light"],
        [data-bs-theme="dark"] {
            --bs-primary: #6b8cae;
            --bs-primary-rgb: 107, 140, 174;
        }
        .btn-primary {
            --bs-btn-bg: #6b8cae;
            --bs-btn-border-color: #6b8cae;
            --bs-btn-hover-bg: #5a7a9a;
            --bs-btn-hover-border-color: #517089;
            --bs-btn-active-bg: #517089;
            --bs-btn-active-border-color: #486580;
        }
        .btn-outline-primary {
            --bs-btn-color: #6b8cae;
            --bs-btn-border-color: #6b8cae;
            --bs-btn-hover-bg: #6b8cae;
            --bs-btn-hover-border-color: #6b8cae;
            --bs-btn-active-bg: #5a7a9a;
            --bs-btn-active-border-color: #5a7a9a;
        }
    </style>

    <!-- htmx (vendored by django-htmx, includes debug extension for error visibility) -->
    {% htmx_script %}

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

    <!-- Theme initialization (before page render to prevent flash) -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>

    <script>
        // Alpine Dice Store - available globally
        document.addEventListener('alpine:init', () => {
            Alpine.store('dice', {
                // Last roll result for display
                lastRoll: null,
                showResult: false,
                resultTimeout: null,
                rollFlash: false,

                // Trigger flash animation
                triggerFlash() {
                    this.rollFlash = false;
                    // Small delay allows DOM to update before re-adding class
                    setTimeout(() => {
                        this.rollFlash = true;
                    }, 10);
                },

                // Core dice rolling function
                roll(notation) {
                    const match = notation.match(/^(\d+)?d(\d+)([+-]\d+)?$/i);
                    if (!match) return null;
                    const count = parseInt(match[1]) || 1;
                    const sides = parseInt(match[2]);
                    const modifier = parseInt(match[3]) || 0;

                    const rolls = [];
                    for (let i = 0; i < count; i++) {
                        rolls.push(Math.floor(Math.random() * sides) + 1);
                    }
                    const sum = rolls.reduce((a, b) => a + b, 0);
                    return { rolls, modifier, total: sum + modifier };
                },

                // Display roll result toast
                // diceBase: "1d20", rolls: [6], modifier: 7, total: 13
                displayResult(label, diceBase, rolls, modifier, total, status = null) {
                    if (this.resultTimeout) clearTimeout(this.resultTimeout);

                    this.lastRoll = { label, diceBase, rolls, modifier, total, status };
                    this.showResult = true;
                    this.triggerFlash();

                    this.resultTimeout = setTimeout(() => {
                        this.showResult = false;
                    }, 5000);
                },

                // Format modifier for display (+7, -2, or empty for 0)
                formatMod(mod) {
                    if (mod === 0) return '';
                    return mod > 0 ? `+${mod}` : `${mod}`;
                },

                // Roll types with pass/fail logic
                rollMorale(ml, name = 'NPC') {
                    const result = this.roll('2d6');
                    const success = result.total <= ml;
                    this.displayResult(
                        `${name} Morale (≤${ml})`,
                        '2d6',
                        result.rolls,
                        0,
                        result.total,
                        success ? 'success' : 'fail'
                    );
                    return { ...result, success };
                },

                rollInstinct(inst, name = 'NPC') {
                    const result = this.roll('1d10');
                    const success = result.total > inst;
                    this.displayResult(
                        `${name} Instinct (>${inst})`,
                        '1d10',
                        result.rolls,
                        0,
                        result.total,
                        success ? 'success' : 'fail'
                    );
                    return { ...result, success };
                },

                rollSave(save, name = 'NPC') {
                    const result = this.roll('1d20');
                    const success = result.total >= save;
                    this.displayResult(
                        `${name} Save (≥${save})`,
                        '1d20',
                        result.rolls,
                        0,
                        result.total,
                        success ? 'success' : 'fail'
                    );
                    return { ...result, success };
                },

                rollAttack(bab, name = 'NPC', weaponName = 'Attack') {
                    const result = this.roll('1d20');
                    const total = result.total + bab;
                    this.displayResult(
                        `${name} ${weaponName}`,
                        '1d20',
                        result.rolls,
                        bab,
                        total
                    );
                    return { ...result, total };
                },

                rollMultipleAttacks(count, bab, name = 'NPC', weaponName = 'Attack') {
                    const attacks = [];
                    for (let i = 0; i < count; i++) {
                        const roll = Math.floor(Math.random() * 20) + 1;
                        attacks.push({ roll, total: roll + bab });
                    }

                    if (this.resultTimeout) clearTimeout(this.resultTimeout);

                    this.lastRoll = {
                        label: `${name} ${weaponName} x${count}`,
                        multipleAttacks: attacks,
                        modifier: bab
                    };
                    this.showResult = true;
                    this.triggerFlash();

                    // Longer timeout for multiple attacks (2 extra seconds per attack)
                    this.resultTimeout = setTimeout(() => {
                        this.showResult = false;
                    }, 5000 + (count * 2000));

                    return attacks;
                },

                rollDamage(notation, name = 'NPC', shock = 0) {
                    const result = this.roll(notation);
                    // Parse notation to get base dice and modifier
                    const match = notation.match(/^(\d+d\d+)([+-]\d+)?$/i);
                    const diceBase = match ? match[1] : notation;
                    const modifier = match && match[2] ? parseInt(match[2]) : 0;

                    // Check if shock is higher than rolled damage
                    const useShock = shock > 0 && shock > result.total;
                    const finalDamage = useShock ? shock : result.total;

                    if (this.resultTimeout) clearTimeout(this.resultTimeout);

                    this.lastRoll = {
                        label: `${name} Damage`,
                        diceBase,
                        rolls: result.rolls,
                        modifier,
                        total: result.total,
                        useShock,
                        shockValue: shock,
                        finalDamage
                    };
                    this.showResult = true;
                    this.triggerFlash();

                    this.resultTimeout = setTimeout(() => {
                        this.showResult = false;
                    }, 5000);

                    return { ...result, finalDamage, useShock };
                },

                rollSkill(skill, name = 'NPC') {
                    const result = this.roll('2d6');
                    const total = result.total + skill;
                    this.displayResult(
                        `${name} Skill`,
                        '2d6',
                        result.rolls,
                        skill,
                        total
                    );
                    return { ...result, total };
                }
            });
        });
    </script>

    <title>{% block title %}{% if current_lang == "uk" %}Гнозис — xWN Правила & Інструменти{% else %}Gnosis — xWN Rules & Tools{% endif %}{% endblock %}</title>

    <style>
        /* Alpine.js cloak */
        [x-cloak] { display: none !important; }

        /* Dice Toast Styles - using Bootstrap variables */
        .dice-toast {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: var(--bs-border-radius);
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 180px;
        }

        @keyframes dice-flash {
            0% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .dice-toast-flash {
            animation: dice-flash 0.3s ease-out;
        }

        .dice-toast-success {
            border-color: var(--bs-success);
            background: linear-gradient(135deg, var(--bs-body-bg) 0%, rgba(25, 135, 84, 0.1) 100%);
        }

        .dice-toast-fail {
            border-color: var(--bs-danger);
            background: linear-gradient(135deg, var(--bs-body-bg) 0%, rgba(220, 53, 69, 0.1) 100%);
        }

        .dice-toast-label {
            font-size: 0.75rem;
            color: var(--bs-secondary-color);
            margin-bottom: 0.25rem;
        }

        .dice-toast-result {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .dice-toast-multi {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .dice-toast-formula {
            display: inline;
        }

        .dice-toast-dice {
            color: var(--bs-body-color);
        }

        .dice-toast-rolls {
            color: var(--bs-primary);
            margin: 0 0.15rem;
        }

        .dice-toast-mod {
            color: var(--bs-secondary-color);
        }

        .dice-toast-equals {
            color: var(--bs-secondary-color);
            font-weight: normal;
        }

        .dice-toast-total {
            color: var(--bs-body-color);
        }

        .dice-toast-replaced {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .dice-toast-shock {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.25rem;
        }

        .dice-toast-arrow {
            color: var(--bs-primary);
        }

        .dice-toast-shock-value {
            font-weight: bold;
            color: var(--bs-primary);
        }

        .dice-toast-shock-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--bs-secondary-color);
        }

        .dice-toast-status {
            font-size: 1.2rem;
        }

        .dice-toast-success .dice-toast-status {
            color: var(--bs-success);
        }

        .dice-toast-fail .dice-toast-status {
            color: var(--bs-danger);
        }

        /* Rollable stat styling */
        .rollable {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }

        .rollable:hover {
            color: var(--bs-primary);
        }

        /* Navbar brand styling */
        .navbar-brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .navbar-brand-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .navbar-brand-subtitle {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Active nav link indicator */
        .nav-link.active {
            font-weight: 600;
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container-fluid">
        <!-- Brand -->
        <a class="navbar-brand d-flex align-items-center gap-2" href="{% url 'tools:home' %}">
            <i class="bi bi-book"></i>
            <span class="navbar-brand-text">
                <span class="navbar-brand-title">{% if current_lang == "uk" %}Гнозис{% else %}Gnosis{% endif %}</span>
                <span class="navbar-brand-subtitle">{% if current_lang == "uk" %}xWN Правила & Інструменти{% else %}xWN Rules & Tools{% endif %}</span>
            </span>
        </a>

        <!-- Mobile toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navbar content -->
        <div class="collapse navbar-collapse" id="navbarMain">
            <!-- Left side nav items -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <!-- Rules link (primary) -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'tools:rules_index' %}">
                        <i class="bi bi-journal-text me-1"></i>{% if current_lang == "uk" %}Правила{% else %}Rules{% endif %}
                    </a>
                </li>

                <!-- Cheatsheets dropdown -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-card-checklist me-1"></i>{% if current_lang == "uk" %}Шпаргалки{% else %}Cheatsheets{% endif %}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'tools:combat_actions' %}">
                            <i class="bi bi-crosshair me-2"></i>{% if current_lang == "uk" %}Дії в Бою{% else %}Combat Actions{% endif %}
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'tools:site_exploration' %}">
                            <i class="bi bi-people me-2"></i>{% if current_lang == "uk" %}Дослідження Локацій{% else %}Site Exploration{% endif %}
                        </a></li>
                        {% comment %}
                        <li><a class="dropdown-item" href="{% url 'tools:wilderness_exploration' %}">
                            <i class="bi bi-tree me-2"></i>{% if current_lang == "uk" %}Подорожі та Виживання{% else %}Wilderness Exploration{% endif %}
                        </a></li>
                        {% endcomment %}
                    </ul>
                </li>

                <!-- Combat Tracker -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'tools:combat_tracker' %}">
                        <i class="bi bi-list-ol me-1"></i>{% if current_lang == "uk" %}Трекер бою{% else %}Combat Tracker{% endif %}
                    </a>
                </li>

                <!-- Faction Tracker -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'tools:faction_tracker' %}">
                        <i class="bi bi-flag me-1"></i>{% if current_lang == "uk" %}Трекер фракцій{% else %}Faction Tracker{% endif %}
                    </a>
                </li>

                <!-- Entities link (hidden until implemented) -->
                {% comment %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'tools:entity_browse' %}">
                        <i class="bi bi-grid-3x3 me-1"></i>Entities
                    </a>
                </li>
                {% endcomment %}
            </ul>

            <!-- Right side controls -->
            <div class="d-flex align-items-center gap-2">
                <!-- Info button -->
                <button class="btn btn-outline-secondary btn-sm" type="button"
                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                        title="Made by John from DMK | xWN systems by Kevin Crawford">
                    <i class="bi bi-info-circle"></i>
                </button>

                <!-- Language toggle -->
                <button class="btn btn-outline-secondary btn-sm" type="button"
                        hx-get="{% url 'tools:set_language' lang=other_lang %}"
                        hx-swap="none"
                        hx-on::after-request="sessionStorage.clear(); localStorage.removeItem('htmx-cache'); window.location.reload(true);"
                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                        title="Switch language">
                    {% if current_lang == "en" %}
                        <span class="fi fi-ua"></span> UK
                    {% else %}
                        <span class="fi fi-gb"></span> EN
                    {% endif %}
                </button>

                <!-- Theme toggle -->
                <button class="btn btn-outline-secondary btn-sm" type="button" id="theme-toggle"
                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                        title="Toggle theme">
                    <i class="bi bi-moon-stars" id="theme-icon-dark"></i>
                    <i class="bi bi-sun" id="theme-icon-light" style="display: none;"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- Dice Roll Result Toast -->
<div x-data x-show="$store.dice?.showResult" x-cloak
     style="position: fixed; bottom: 1rem; right: 1rem; z-index: 9999;"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0 transform translate-y-2"
     x-transition:enter-end="opacity-100 transform translate-y-0"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <div class="dice-toast"
         :class="{
             'dice-toast-success': $store.dice?.lastRoll?.status === 'success',
             'dice-toast-fail': $store.dice?.lastRoll?.status === 'fail',
             'dice-toast-flash': $store.dice?.rollFlash
         }">
        <div class="dice-toast-label" x-text="$store.dice?.lastRoll?.label"></div>
        <!-- Single roll result -->
        <template x-if="!$store.dice?.lastRoll?.multipleAttacks">
            <div class="dice-toast-result">
                <span class="dice-toast-formula">
                    <span class="dice-toast-dice" x-text="$store.dice?.lastRoll?.diceBase"></span><span class="dice-toast-rolls" x-text="'[' + ($store.dice?.lastRoll?.rolls?.join(', ') || '') + ']'"></span><span class="dice-toast-mod" x-show="$store.dice?.lastRoll?.modifier !== 0" x-text="$store.dice.formatMod($store.dice?.lastRoll?.modifier)"></span>
                </span>
                <span class="dice-toast-equals">=</span>
                <!-- Show rolled total, struck through if shock is higher -->
                <span class="dice-toast-total"
                      :class="{ 'dice-toast-replaced': $store.dice?.lastRoll?.useShock }"
                      x-text="$store.dice?.lastRoll?.total"></span>
                <!-- Show shock replacement when applicable -->
                <template x-if="$store.dice?.lastRoll?.useShock">
                    <span class="dice-toast-shock">
                        <span class="dice-toast-arrow">-></span>
                        <span class="dice-toast-shock-value" x-text="$store.dice?.lastRoll?.shockValue"></span>
                        <span class="dice-toast-shock-label">shock</span>
                    </span>
                </template>
                <span class="dice-toast-status" x-show="$store.dice?.lastRoll?.status"
                      x-text="$store.dice?.lastRoll?.status === 'success' ? '✓' : '✗'"></span>
            </div>
        </template>
        <!-- Multiple attack rolls -->
        <template x-if="$store.dice?.lastRoll?.multipleAttacks">
            <div class="dice-toast-multi">
                <template x-for="(attack, index) in $store.dice?.lastRoll?.multipleAttacks" :key="index">
                    <div class="dice-toast-result">
                        <span class="dice-toast-formula">
                            <span class="dice-toast-dice">1d20</span><span class="dice-toast-rolls" x-text="'[' + attack.roll + ']'"></span><span class="dice-toast-mod" x-show="$store.dice?.lastRoll?.modifier !== 0" x-text="$store.dice.formatMod($store.dice?.lastRoll?.modifier)"></span>
                        </span>
                        <span class="dice-toast-equals">=</span>
                        <span class="dice-toast-total" x-text="attack.total"></span>
                    </div>
                </template>
            </div>
        </template>
    </div>
</div>

<!-- Main content -->
<main class="container-fluid py-4">
    {% block content %}{% endblock %}
</main>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    });

    // Theme toggle functionality
    const themeToggle = document.getElementById('theme-toggle');
    const themeIconDark = document.getElementById('theme-icon-dark');
    const themeIconLight = document.getElementById('theme-icon-light');

    function updateThemeIcon(theme) {
        if (theme === 'dark') {
            themeIconDark.style.display = 'inline';
            themeIconLight.style.display = 'none';
        } else {
            themeIconDark.style.display = 'none';
            themeIconLight.style.display = 'inline';
        }
    }

    // Initialize icon based on current theme
    updateThemeIcon(document.documentElement.getAttribute('data-bs-theme'));

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    });
</script>

{% block extra_scripts %}{% endblock %}
</body>
</html>
