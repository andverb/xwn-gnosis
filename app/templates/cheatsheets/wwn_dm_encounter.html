{% extends "base.html" %}

{% block title %}WWN DM Encounter Cheatsheet - Gnosis{% endblock %}

{% block extra_head %}
<style>
    /* Cheatsheet-specific styles */
    .cheatsheet-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media (max-width: 1200px) {
        .cheatsheet-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .cheatsheet-grid {
            grid-template-columns: 1fr;
        }
    }

    .cheatsheet-card {
        background: var(--pico-card-background-color);
        border: 1px solid var(--pico-muted-border-color);
        border-radius: var(--pico-border-radius);
        padding: 1rem;
    }

    .cheatsheet-card h3 {
        margin-top: 0;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--pico-primary);
    }

    .dice {
        font-family: monospace;
        font-weight: bold;
        color: var(--pico-primary);
    }

    .modifier-positive { color: #198754; font-weight: bold; }
    .modifier-negative { color: #dc3545; font-weight: bold; }

    .action-item {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--pico-muted-border-color);
    }

    .action-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .action-item h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
    }

    .action-item p, .action-item ul,
    .cheatsheet-card > ul {
        margin: 0;
        font-size: 0.9rem;
        color: var(--pico-muted-color);
    }

    .action-item ul,
    .cheatsheet-card > ul {
        padding-left: 1.2rem;
        margin-top: 0.25rem;
    }

    .action-item li,
    .cheatsheet-card > ul > li {
        margin-bottom: 0.25rem;
    }

    .formula-box {
        background: var(--pico-code-background-color);
        padding: 0.75rem;
        border-radius: 0.25rem;
        font-family: monospace;
        font-size: 1rem;
        margin: 0.5rem 0;
        text-align: center;
    }

    .trigger-list {
        font-size: 0.85rem;
    }

    .trigger-list li {
        margin-bottom: 0.4rem;
        padding-left: 0.5rem;
        border-left: 3px solid var(--pico-primary);
    }

    .instinct-table {
        font-size: 0.85rem;
        width: 100%;
        margin: 0.5rem 0;
    }

    .instinct-table .inst-row {
        display: flex;
        justify-content: space-between;
        padding: 0.3rem 0;
        border-bottom: 1px solid var(--pico-muted-border-color);
    }

    .instinct-table .inst-row:last-child {
        border-bottom: none;
    }

    .instinct-table .inst-score {
        font-weight: bold;
        color: var(--pico-primary);
        min-width: 2rem;
    }

    .instinct-table .inst-desc {
        color: var(--pico-muted-color);
    }

    /* Reaction table with color coding */
    .reaction-table {
        font-size: 0.85rem;
        width: 100%;
    }

    .reaction-row {
        display: flex;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.25rem;
        margin-bottom: 0.25rem;
    }

    .reaction-row:last-child {
        margin-bottom: 0;
    }

    .reaction-score {
        font-weight: bold;
        min-width: 2.5rem;
    }

    .reaction-hostile {
        background: rgba(220, 53, 69, 0.2);
    }

    .reaction-unfriendly {
        background: rgba(253, 126, 20, 0.15);
    }

    .reaction-neutral {
        background: rgba(255, 193, 7, 0.15);
    }

    .reaction-friendly {
        background: rgba(25, 135, 84, 0.15);
    }

    .reaction-helpful {
        background: rgba(25, 135, 84, 0.25);
    }

    /* Light mode colors */
    [data-theme="light"] .reaction-hostile { color: #dc3545; }
    [data-theme="light"] .reaction-unfriendly { color: #d67212; }
    [data-theme="light"] .reaction-neutral { color: #806600; }
    [data-theme="light"] .reaction-friendly { color: #157347; }
    [data-theme="light"] .reaction-helpful { color: #0f5132; }

    /* Dark mode colors */
    [data-theme="dark"] .reaction-hostile { color: #ff6b7a; }
    [data-theme="dark"] .reaction-unfriendly { color: #ffa64d; }
    [data-theme="dark"] .reaction-neutral { color: #ffda6a; }
    [data-theme="dark"] .reaction-friendly { color: #5dd39e; }
    [data-theme="dark"] .reaction-helpful { color: #75e8b0; }

    /* Column span utilities */
    .full-width {
        grid-column: 1 / -1;
    }

    .span-2 {
        grid-column: span 2;
    }

    @media (max-width: 768px) {
        .span-2 {
            grid-column: span 1;
        }
    }

    /* Calculator specific styles */
    .calculator-sides {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .calculator-side {
        background: var(--pico-code-background-color);
        padding: 0.75rem;
        border-radius: 0.5rem;
    }

    .calculator-side h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        text-align: center;
    }

    .side-foes h4 { color: #dc3545; }
    .side-party h4 { color: #198754; }

    .calculator-side .field-row {
        display: flex;
        gap: 0.5rem;
    }

    .calculator-side .field-group {
        flex: 1;
        text-align: center;
    }

    .calculator-side input {
        margin-bottom: 0;
        padding: 0.4rem;
        text-align: center;
        width: 100%;
    }

    .calculator-side .field-label {
        font-size: 0.7rem;
        color: var(--pico-muted-color);
        display: block;
        margin-top: 0.2rem;
    }

    .calculator-result {
        background: var(--pico-code-background-color);
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
    }

    .calculator-result .scores {
        display: flex;
        justify-content: space-around;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .calculator-result .score-box {
        text-align: center;
    }

    .calculator-result .score-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--pico-primary);
    }

    .calculator-result .score-label {
        font-size: 0.75rem;
        color: var(--pico-muted-color);
    }

    .calculator-result .verdict {
        font-weight: bold;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }

    .verdict-rout { background: #dc3545; color: white; }
    .verdict-deadly { background: #fd7e14; color: white; }
    .verdict-hard { background: #ffc107; color: #212529; }
    .verdict-fair { background: #198754; color: white; }
    .verdict-easy { background: #0d6efd; color: white; }

    @media print {
        body { background: white; }
        .no-print { display: none; }
        .cheatsheet-card { break-inside: avoid; }
    }

    .back-link {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="back-link no-print">
    <a href="/">&larr; Back to Search</a>
    <a href="/cheatsheets/wwn-combat" style="margin-left: 1rem;">Combat Cheatsheet</a>
    <button onclick="window.print()" style="float: right;">Print</button>
</div>

<hgroup style="text-align: center; margin-bottom: 2rem;">
    <h1>WWN DM Encounter Cheatsheet</h1>
    <p>Quick reference for running encounters</p>
</hgroup>

<div class="cheatsheet-grid">

    <!-- Challenge Calculator -->
    <article class="cheatsheet-card">
        <h3>Challenge Calculator</h3>

        <form id="challenge-form"
              hx-post="/cheatsheets/calculate-challenge"
              hx-target="#calculator-result"
              hx-trigger="input delay:150ms, submit"
              hx-swap="innerHTML">
            <div class="calculator-sides">
                <div class="calculator-side side-foes">
                    <h4>Foes</h4>
                    <div class="field-row">
                        <div class="field-group">
                            <input type="number" id="total_hd" name="total_hd" min="1" value="1">
                            <span class="field-label">HD (total)</span>
                        </div>
                        <div class="field-group">
                            <input type="number" id="total_attacks" name="total_attacks" min="1" value="1">
                            <span class="field-label">Attacks (total)</span>
                        </div>
                    </div>
                </div>
                <div class="calculator-side side-party">
                    <h4>Party</h4>
                    <div class="field-row">
                        <div class="field-group">
                            <input type="number" id="num_pcs" name="num_pcs" min="1" value="4">
                            <span class="field-label"># of PCs</span>
                        </div>
                        <div class="field-group">
                            <input type="number" id="total_pc_levels" name="total_pc_levels" min="1" value="4">
                            <span class="field-label">Levels (total)</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="calculator-result">
            {% include "cheatsheets/_challenge_result.html" %}
        </div>

        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--pico-muted-color); text-align: center;">
            Foe &gt;4&times; = Rout |
            ~2&times; = Deadly |
            &gt;1&times; = Hard |
            &le;1&times; = Fair |
            &lt;&half;&times; = Easy
        </div>
    </article>

    <script>
    (function() {
        const hdInput = document.getElementById('total_hd');
        const attacksInput = document.getElementById('total_attacks');
        const pcsInput = document.getElementById('num_pcs');
        const levelsInput = document.getElementById('total_pc_levels');

        // Foes: HD up → attacks bumps up; attacks down → HD drops
        hdInput.addEventListener('input', function() {
            const hd = parseInt(this.value) || 1;
            const attacks = parseInt(attacksInput.value) || 1;
            if (attacks < hd) attacksInput.value = hd;
        });

        attacksInput.addEventListener('input', function() {
            const hd = parseInt(hdInput.value) || 1;
            const attacks = parseInt(this.value) || 1;
            if (attacks < hd) hdInput.value = attacks;
        });

        // Party: PCs up → levels bumps up; levels down → PCs drops
        pcsInput.addEventListener('input', function() {
            const pcs = parseInt(this.value) || 1;
            const levels = parseInt(levelsInput.value) || 1;
            if (levels < pcs) levelsInput.value = pcs;
        });

        levelsInput.addEventListener('input', function() {
            const pcs = parseInt(pcsInput.value) || 1;
            const levels = parseInt(this.value) || 1;
            if (levels < pcs) pcsInput.value = levels;
        });
    })();
    </script>

    <!-- Morale Checks -->
    <article class="cheatsheet-card">
        <h3>Morale Checks</h3>

        <div class="action-item">
            <h4>The Roll</h4>
            <div class="formula-box">
                <span class="dice">2d6</span> &gt; ML = <span class="modifier-negative">Fail</span>
            </div>
            <p>On failure: NPC retreats, surrenders, or seeks to escape.</p>
        </div>

        <div class="action-item">
            <h4>When to Roll</h4>
            <ul class="trigger-list">
                <li><strong>First casualty</strong> - When first member of a group is killed or incapacitated</li>
                <li><strong>Losing badly</strong> - Group starts to visibly lose or odds of victory shrink</li>
                <li><strong>Terror</strong> - Facing terrifying magic, horrendous slaughter, or vastly superior foe</li>
                <li><strong>Non-combatant</strong> - Civilian first faced with serious physical harm</li>
                <li><strong>Ambush</strong> - Undisciplined targets may check when ambushed (GM discretion)</li>
            </ul>
        </div>

        <div class="action-item">
            <h4>Failure Consequences</h4>
            <ul>
                <li><strong>Non-combatants:</strong> Flee madly, drop everything</li>
                <li><strong>Trained fighters:</strong> Fighting withdrawal, try to escape with comrades</li>
                <li><strong>If escape impossible:</strong> Surrender, collapse in despair, or fight with frenzy</li>
            </ul>
        </div>

        <p style="font-size: 0.8rem; color: var(--pico-muted-color);">
            <strong>Typical ML:</strong> 2-5 cowardly, 6-7 average, 8-9 brave, 10-11 fearless, 12 unbreakable. PCs never check.
        </p>
    </article>

    <!-- Instinct Checks -->
    <article class="cheatsheet-card">
        <h3>Instinct Checks</h3>

        <div class="action-item">
            <h4>The Roll</h4>
            <div class="formula-box">
                <span class="dice">1d10</span> &le; Inst = <span class="modifier-negative">Fail</span>
            </div>
            <p>On failure: NPC acts impulsively, short-sightedly, instinctually.</p>
        </div>

        <div class="action-item">
            <h4>When to Roll</h4>
            <ul class="trigger-list">
                <li><strong>Round 2+</strong> - Second round of combat for mobs and undisciplined fighters</li>
                <li><strong>After Morale</strong> - Creature just had to make a Morale check</li>
                <li><strong>Confusion</strong> - Enemy did something confusing or disorienting</li>
                <li><strong>Provoked</strong> - Enemy enraged or directly intimidated the creature</li>
                <li><strong>Temptation</strong> - Presented with something it desires (food, money, etc.)</li>
            </ul>
        </div>

        <div class="action-item">
            <h4>Failure Examples</h4>
            <ul>
                <li>Attack sub-optimal targets blindly</li>
                <li>Use unarmed attacks instead of weapon in hand</li>
                <li>Aim spells/shots at targets of lesser importance</li>
                <li>Chase after dropped bait instead of fighting</li>
            </ul>
        </div>

        <p style="font-size: 0.8rem; color: var(--pico-muted-color);">
            <strong>Typical Inst:</strong> 5+ beasts/civilians, 3-4 veterans, 1-2 hardened, 0 coldest killers. PCs never check. Optional.
        </p>
    </article>

    <!-- Reaction Rolls -->
    <article class="cheatsheet-card">
        <h3>Reaction Rolls</h3>

        <div class="action-item">
            <div class="formula-box">
                <span class="dice">2d6</span> + Cha mod
                (if PCs can greet)
            </div>
            <p>Roll for every encounter unless bloodshed is inevitable. Clue PCs into results before they act.</p>
        </div>

        <div class="action-item">
            <div class="reaction-table">
                <div class="reaction-row reaction-hostile">
                    <span class="reaction-score">2-</span>
                    <span class="reaction-desc">Hostile as the situation allows</span>
                </div>
                <div class="reaction-row reaction-unfriendly">
                    <span class="reaction-score">3-5</span>
                    <span class="reaction-desc">More unfriendly than expected</span>
                </div>
                <div class="reaction-row reaction-neutral">
                    <span class="reaction-score">6-8</span>
                    <span class="reaction-desc">Predictably hostile or friendly</span>
                </div>
                <div class="reaction-row reaction-friendly">
                    <span class="reaction-score">9-11</span>
                    <span class="reaction-desc">More friendly than expected</span>
                </div>
                <div class="reaction-row reaction-helpful">
                    <span class="reaction-score">12+</span>
                    <span class="reaction-desc">As friendly and helpful as possible</span>
                </div>
            </div>
        </div>

        <div class="action-item">
            <h4>Peaceful Reactions</h4>
            <p style="font-size: 0.8rem; color: var(--pico-muted-color); margin-bottom: 0.5rem;">What "friendly" means for hostile groups:</p>
            <ul>
                <li><strong>Demand a bribe</strong> - Money, gear, food, praise; haggling possible</li>
                <li><strong>Back off</strong> - Keep distance, let groups pass; may report later</li>
                <li><strong>Ask for favors</strong> - Enemy killed, task done; offer to ignore PCs in return</li>
                <li><strong>Offer tribute</strong> - Wealth, info, services to be left alone</li>
                <li><strong>Willingly socialize</strong> - Lonely, mistaken identity, or just chatty</li>
            </ul>
        </div>

        <p style="font-size: 0.85rem; color: var(--pico-muted-color);">
            <strong>Remember:</strong> Reaction rolls are just the start. Clever words, gifts, or insults can shift attitudes.
        </p>
    </article>

    <!-- Running NPC Combat & Fleeing -->
    <article class="cheatsheet-card">
        <h3>Running NPCs & Fleeing</h3>

        <div class="action-item">
            <h4>NPC Combat Tips</h4>
            <ul>
                <li>NPCs won't fight to the death unless they must</li>
                <li>Check Morale when things go badly</li>
                <li>Check Instinct when confused or provoked</li>
                <li>Let NPCs make tactical errors - they're not perfect</li>
                <li>Once Morale fails, side won't fight those foes until courage recovered</li>
            </ul>
        </div>

        <div class="action-item">
            <h4>GM Guidance</h4>
            <ul>
                <li>Be charitable about letting PCs run away</li>
                <li>Most pursuers won't be relentlessly persistent</li>
                <li>Running away is a viable option, not an excuse to die tired</li>
            </ul>
        </div>
    </article>

    <!-- Chases -->
    <article class="cheatsheet-card span-2">
        <h3>Chases & Pursuit</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- Foot Chase -->
            <div>
                <h4 style="margin-top: 0;">Foot Chase</h4>
                <ol style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem; color: var(--pico-muted-color);">
                    <li><strong>Fleeing pace:</strong> Best Dex/Exert or Con/Exert in fleeing group rolls = <strong>Pace</strong></li>
                    <li><strong>Helpers:</strong> Other fleeing members hinder pursuit (skill check or GM judgment). Success = <span class="modifier-positive">+1</span> to Pace each, max <span class="modifier-positive">+3</span></li>
                    <li><strong>Pursuers roll:</strong> Single Dex/Exert or Con/Exert check with modifiers</li>
                    <li><strong>Result:</strong> Beat Pace = <span class="modifier-negative">caught</span>. Tie or less = <span class="modifier-positive">escaped</span></li>
                </ol>

                <h4 style="margin-top: 0.75rem;">Foot Chase Pace Modifiers</h4>
                <div class="instinct-table">
                    <div class="inst-row">
                        <span class="inst-desc">No head start at all</span>
                        <span class="inst-score">+2</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">One round head start</span>
                        <span class="inst-score">+1</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">&lt;1 minute head start</span>
                        <span class="inst-score">+0</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">&gt;1 minute head start</span>
                        <span class="inst-score">-2</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">More pursuers than pursued</span>
                        <span class="inst-score">-1</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Terrain knowledge</span>
                        <span class="inst-score">-2 to +2</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Half-hearted / Enraged</span>
                        <span class="inst-score">-1 / +1</span>
                    </div>
                </div>
            </div>

            <!-- Mounted Chase -->
            <div>
                <h4 style="margin-top: 0;">Mounted Chase</h4>
                <ol style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem; color: var(--pico-muted-color);">
                    <li><strong>Fleeing pace:</strong> Fleeing rider rolls Dex/Ride = <strong>Pace</strong></li>
                    <li><strong>Each pursuer rolls:</strong> Dex/Ride with modifiers</li>
                    <li><strong>Result:</strong> Meet or exceed Pace = <span class="modifier-negative">catch up</span>. Fail = <span class="modifier-positive">fall behind & lost</span></li>
                </ol>
                <p style="font-size: 0.85rem; color: var(--pico-muted-color); margin: 0.5rem 0;">
                    <strong>Note:</strong> Unmounted pursuers cannot catch mounted evaders in short-term chases.
                </p>

                <h4 style="margin-top: 0.75rem;">Mounted Chase Pace Modifiers</h4>
                <div class="instinct-table">
                    <div class="inst-row">
                        <span class="inst-desc">Can't directly see pursued</span>
                        <span class="inst-score">-2</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Pursuer flying, pursued not</span>
                        <span class="inst-score">+3</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Pursued flying, pursuer not</span>
                        <span class="inst-score">-3</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Spotter relaying position</span>
                        <span class="inst-score">+1</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Terrain knowledge</span>
                        <span class="inst-score">-2 to +2</span>
                    </div>
                    <div class="inst-row">
                        <span class="inst-desc">Half-hearted / Enraged</span>
                        <span class="inst-score">-1 / +1</span>
                    </div>
                </div>
            </div>
        </div>
    </article>

</div>

<footer style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--pico-muted-border-color);">
    <small>WWN by Kevin Crawford. Cheatsheet content compiled for quick reference.</small>
</footer>
{% endblock %}
