{% extends "tools/wwn/cheatsheets/cheatsheet_base.html" %}

{% block title %}Шпаргалка Зіткнень - Gnosis{% endblock %}

{% block cheatsheet_styles %}
<style>
    /* Compact table */
    .compact-table {
        width: 100%;
        font-size: 0.85rem;
        margin: 0.5rem 0;
    }
    .compact-table th {
        font-weight: 600;
        color: var(--bs-secondary-color);
        font-size: 0.75rem;
        text-transform: uppercase;
    }
    .compact-table td:first-child {
        font-weight: bold;
        color: var(--bs-primary);
        width: 3rem;
        text-align: center;
    }
    .compact-table td:last-child {
        color: var(--bs-secondary-color);
    }

    /* Turn Tracker */
    .turn-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.5rem;
    }
    .turn-table th,
    .turn-table td {
        padding: 0.25rem;
        text-align: center;
        border: 1px solid var(--bs-border-color);
    }
    .turn-table th {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        background: var(--bs-tertiary-bg);
    }
    .turn-table .row-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        background: var(--bs-tertiary-bg);
        width: 3rem;
    }
    .turn-table input[type="checkbox"] {
        margin: 0;
        width: 1.1rem;
        height: 1.1rem;
    }
    .turn-legend {
        display: flex;
        gap: 1rem;
        align-items: center;
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
    }
    .turn-table .reset-btn {
        width: 1.5rem;
        height: 1.5rem;
        padding: 0;
        font-size: 0.9rem;
        line-height: 1;
        margin: 0;
    }

    /* Formula box (centered, monospace - encounter specific) */
    .formula-box {
        font-family: monospace;
        font-size: 1rem;
        text-align: center;
        padding: 0.75rem;
    }

    /* Variant rule styling */
    .variant {
        color: #6f42c1;
        cursor: help;
        border-bottom: 1px dotted #6f42c1;
    }
    [data-bs-theme="dark"] .variant {
        color: #b794f6;
        border-bottom-color: #b794f6;
    }

    /* Trigger list */
    .trigger-list {
        font-size: 0.85rem;
        list-style: none;
        padding-left: 0;
    }
    .trigger-list li {
        margin-bottom: 0.4rem;
        padding-left: 0.75rem;
        border-left: 3px solid var(--bs-primary);
    }

    /* Reaction table with color coding */
    .reaction-table {
        font-size: 0.85rem;
        width: 100%;
    }
    .reaction-row {
        display: flex;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.25rem;
        margin-bottom: 0.25rem;
    }
    .reaction-row:last-child {
        margin-bottom: 0;
    }
    .reaction-score {
        font-weight: bold;
        min-width: 2.5rem;
    }
    .reaction-hostile { background: rgba(220, 53, 69, 0.2); color: var(--bs-danger); }
    .reaction-unfriendly { background: rgba(253, 126, 20, 0.15); color: #fd7e14; }
    .reaction-neutral { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
    .reaction-friendly { background: rgba(25, 135, 84, 0.15); color: var(--bs-success); }
    .reaction-helpful { background: rgba(25, 135, 84, 0.25); color: var(--bs-success); }

    /* Calculator specific styles */
    .calculator-sides {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .calculator-side {
        background: var(--bs-tertiary-bg);
        padding: 0.75rem;
        border-radius: 0.5rem;
    }
    .calculator-side h5 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        text-align: center;
    }
    .side-foes h5 { color: var(--bs-danger); }
    .side-party h5 { color: var(--bs-success); }
    .calculator-side .field-row {
        display: flex;
        gap: 0.5rem;
    }
    .calculator-side .field-group {
        flex: 1;
        text-align: center;
    }
    .calculator-side input {
        margin-bottom: 0;
        padding: 0.4rem;
        text-align: center;
        width: 100%;
    }
    .calculator-side .field-label {
        font-size: 0.7rem;
        color: var(--bs-secondary-color);
        display: block;
        margin-top: 0.2rem;
    }
    .calculator-result {
        background: var(--bs-tertiary-bg);
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    .calculator-result .scores {
        display: flex;
        justify-content: space-around;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }
    .calculator-result .score-box {
        text-align: center;
    }
    .calculator-result .score-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--bs-primary);
    }
    .calculator-result .score-label {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
    }
    .calculator-result .verdict {
        font-weight: bold;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }
    .verdict-rout { background: #dc3545; color: white; }
    .verdict-deadly { background: #fd7e14; color: white; }
    .verdict-hard { background: #ffc107; color: #212529; }
    .verdict-fair { background: #198754; color: white; }
    .verdict-easy { background: #0d6efd; color: white; }
    .challenge-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.4rem;
        margin-top: 0.75rem;
    }
    .challenge-legend .legend-item {
        font-size: 0.7rem;
        font-weight: bold;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block cheatsheet_content %}
<div class="container">
    <div class="text-center mb-4">
        <h1 class="h2">Шпаргалка Зіткнень</h1>
    </div>

    <div class="row g-3">

        <!-- Ruin Turns & Encounters -->
        <div class="col-12 col-lg-4">
            <div class="card h-100" x-data="turnTracker">
                <div class="card-header">
                    <h5 class="card-title mb-0">Ходи &amp; Зіткнення</h5>
                </div>
                <div class="card-body">
                    <table class="turn-table">
                        <thead>
                            <tr>
                                <th><button class="btn btn-sm btn-outline-secondary reset-btn" @click="turns = 0" title="Скинути">&#8634;</button></th>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns < 6" x-text="time"></span>
                                    <span x-show="turns >= 6">&#128293;</span>
                                </td>
                                <template x-for="i in 6" :key="i">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i" @change="turns = turns >= i ? i - 1 : i"></td>
                                </template>
                            </tr>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns >= 6 && turns < 12" x-text="time"></span>
                                    <span x-show="turns >= 12">&#128293;</span>
                                </td>
                                <template x-for="i in 6" :key="i + 6">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i + 6" @change="turns = turns >= i + 6 ? i + 5 : i + 6"></td>
                                </template>
                            </tr>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns >= 12 && turns < 18" x-text="time"></span>
                                    <span x-show="turns >= 18">&#128293;</span>
                                </td>
                                <template x-for="i in 6" :key="i + 12">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i + 12" @change="turns = turns >= i + 12 ? i + 11 : i + 12"></td>
                                </template>
                            </tr>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns >= 18 && turns < 24" x-text="time"></span>
                                    <span x-show="turns >= 24">&#128293;&#127982;</span>
                                </td>
                                <template x-for="i in 6" :key="i + 18">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i + 18" @change="turns = turns >= i + 18 ? i + 17 : i + 18"></td>
                                </template>
                            </tr>
                        </tbody>
                    </table>

                    <div class="turn-legend">
                        <span>&#128293; смолоскип (6 ходів / 1г)</span>
                        <span>&#127982; ліхтар (24 ходи / 4г)</span>
                    </div>

                    <div class="small text-body-secondary mt-2 mb-3">
                        <p class="mb-1"><strong>1 хід = 10 хвилин:</strong></p>
                        <ul class="mb-0">
                            <li>Рух між кімнатами</li>
                            <li>Злом замка</li>
                            <li>Знешкодження пастки</li>
                            <li>Бій</li>
                            <li>Перша допомога &amp; обшук</li>
                            <li>Обшук кімнати</li>
                            <li>Переговори</li>
                            <li>Імпровізований ремонт</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Перевірка Зіткнення</h5>
                        <ul class="mb-0">
                            <li>Кидок <span class="dice" x-data="rollable" data-notation="1d6" @click="roll()" :class="{ 'rolled': rolled }" title="Натисніть для кидка" x-text="displayText">1к6</span> — зіткнення на <strong>1</strong> (на <strong>1–2</strong> в небезпечних зонах)</li>
                            <li>Відстань: кімната — найближчий вхід; коридор — <span class="dice" x-data="rollable" data-notation="1d8" @click="roll()" :class="{ 'rolled': rolled }" title="Натисніть для кидка" x-text="displayText">1к8</span> × 10 футів</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Частота Перевірок</h5>
                        <table class="table table-sm compact-table">
                            <thead>
                                <tr><th>Ходів</th><th>Тип Локації</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>1</td><td>Місце в стані тривоги, організована оборона</td></tr>
                                <tr><td>2</td><td>Спокійне місце, організована оборона</td></tr>
                                <tr><td>3</td><td>Без організованої або активної оборони</td></tr>
                                <tr><td>4</td><td>Дуже мало мобільних мешканців</td></tr>
                                <tr><td>6</td><td>Покинуте або занедбане місце</td></tr>
                                <tr><td>—</td><td>Прихована кімната, невідома місцевим</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reaction Rolls -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Кидки на Реакцію</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="2d6" @click="roll()" :class="{ 'rolled': rolled }" title="Натисніть для кидка" x-text="displayText">2к6</span> + мод. ХАР (якщо ПГ можуть привітатись)
                        </div>
                        <p>Кидайте для кожної зустрічі, окрім випадків неминучого кровопролиття. Дайте ПГ зрозуміти результат до їхніх дій.</p>
                    </div>

                    <div class="action-item">
                        <div class="reaction-table">
                            <div class="reaction-row reaction-hostile">
                                <span class="reaction-score">2-</span>
                                <span class="reaction-desc">Максимально ворожа</span>
                            </div>
                            <div class="reaction-row reaction-unfriendly">
                                <span class="reaction-score">3-5</span>
                                <span class="reaction-desc">Більш ворожа, ніж очікувалось</span>
                            </div>
                            <div class="reaction-row reaction-neutral">
                                <span class="reaction-score">6-8</span>
                                <span class="reaction-desc">Передбачувано ворожа або дружня</span>
                            </div>
                            <div class="reaction-row reaction-friendly">
                                <span class="reaction-score">9-11</span>
                                <span class="reaction-desc">Більш дружня, ніж очікувалось</span>
                            </div>
                            <div class="reaction-row reaction-helpful">
                                <span class="reaction-score">12+</span>
                                <span class="reaction-desc">Максимально дружня, готові допомагати</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-item">
                        <h5>Мирні Реакції</h5>
                        <p class="small text-body-secondary mb-2">Що означає "дружня" реакція для ворожих груп:</p>
                        <ul class="small ps-3">
                            <li><strong>Вимагають хабар</strong> - Гроші, спорядження, їжа, похвала; можливий торг</li>
                            <li><strong>Відступають</strong> - Тримають дистанцію, пропускають групу; можуть донести пізніше</li>
                            <li><strong>Просять про послугу</strong> - Вбити ворога, виконати завдання; за це ігнорують ПГ</li>
                            <li><strong>Пропонують данину</strong> - Багатство, інформація, послуги, щоб їх залишили в спокої</li>
                            <li><strong>Охоче спілкуються</strong> - Самотні, переплутали з кимось знайомим, або просто балакучі</li>
                        </ul>
                    </div>

                    <p class="small text-body-secondary mb-0">
                        <strong>Пам'ятайте:</strong> Кидки на реакцію - лише початок. Розумні слова, дарунки або образи можуть змінити ставлення.
                    </p>
                </div>
            </div>
        </div>

        <!-- Surprise & Initiative -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Засідки &amp; Ініціатива</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <h5>Несподіванка</h5>
                        <p>Якщо ГМ вирішує, що несподіванка можлива, кидок <strong>МУД/УВАГА</strong> проти <strong>СПР/СКРАДАННЯ</strong>. Якщо атакуючі перемагають, вони діють повний раунд перед кидком ініціативи.</p>
                        <p class="small text-body-secondary">Засідка може спровокувати перевірку Моралі у невійськових або недисциплінованих цілей (на розсуд ГМ).</p>
                    </div>

                    <div class="action-item">
                        <h5>Ініціатива</h5>
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="1d8" @click="roll()" :class="{ 'rolled': rolled }" title="Натисніть для кидка" x-text="displayText">1к8</span> + найвищий мод. СПР <span class="variant" title="Варіант правила">(або ІНТ)</span>
                        </div>
                        <p>Кожна сторона кидає. Переможці діють першими у будь-якому порядку, потім інша сторона. НІПи зазвичай без модифікаторів, якщо не швидкі. ПГ перемагають у нічиїх.</p>
                        <p class="small text-body-secondary mt-2"><span class="variant" title="Варіант індивідуальної ініціативи">Варіант:</span> Кожен учасник кидає власну ініціативу та діє по порядку.</p>
                    </div>

                    <div class="action-item">
                        <h5>Втеча &amp; Порятунок</h5>
                        <p>Якщо вороги переслідують (багато не роблять цього), втікач із найкращою <strong>СПР/АТЛЕТИКА</strong> кидає проти найшвидшого переслідувача. Успіх = ~1 хід до безпеки.</p>
                        <div class="modifier-table mt-2">
                            <div class="mod-table-row">
                                <span class="mod-table-desc">Втікачів більше, ніж переслідувачів</span>
                                <span class="mod-table-value modifier-positive">+1</span>
                            </div>
                            <div class="mod-table-row">
                                <span class="mod-table-desc">Хороший план втечі</span>
                                <span class="mod-table-value modifier-positive">+1</span>
                            </div>
                            <div class="mod-table-row">
                                <span class="mod-table-desc">Сповільнені найповільнішим членом</span>
                                <span class="mod-table-value modifier-negative">-2</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenge Calculator -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Розрахунок Складності</h5>
                </div>
                <div class="card-body">
                    <form id="challenge-form"
                          hx-post="{% url 'tools:calculate_challenge' %}"
                          hx-target="#calculator-result"
                          hx-trigger="load, input delay:150ms, submit"
                          hx-swap="innerHTML"
                          autocomplete="off">
                        <input type="hidden" name="lang" value="uk">
                        <div class="calculator-sides">
                            <div class="calculator-side side-foes">
                                <h5>Вороги</h5>
                                <div class="field-row">
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="total_hd" name="total_hd" min="1" value="1">
                                        <span class="field-label">КХ (сума)</span>
                                    </div>
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="total_attacks" name="total_attacks" min="1" value="1">
                                        <span class="field-label">Атаки (сума)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="calculator-side side-party">
                                <h5>Група</h5>
                                <div class="field-row">
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="num_pcs" name="num_pcs" min="1" value="4">
                                        <span class="field-label">К-сть ПГ</span>
                                    </div>
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="total_pc_levels" name="total_pc_levels" min="1" value="4">
                                        <span class="field-label">Рівні (сума)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div id="calculator-result">
                        {% include "tools/wwn/cheatsheets/partials/_challenge_result_uk.html" %}
                    </div>

                    <div class="challenge-legend">
                        <span class="legend-item verdict-rout">&gt;4× Розгром</span>
                        <span class="legend-item verdict-deadly">~2× Смертельно</span>
                        <span class="legend-item verdict-hard">&gt;1× Важко</span>
                        <span class="legend-item verdict-fair">&le;1× Справедливо</span>
                        <span class="legend-item verdict-easy">&lt;½× Легко</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Morale Checks -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Перевірки Моралі</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="2d6" @click="roll()" :class="{ 'rolled': rolled }" title="Натисніть для кидка" x-text="displayText">2к6</span> &gt; Мораль = <span class="modifier-negative">Провал</span>
                        </div>
                        <p>При провалі: НІП відступає, здається або намагається втекти.</p>
                    </div>

                    <div class="action-item">
                        <h5>Коли Кидати</h5>
                        <ul class="trigger-list">
                            <li><strong>Перша втрата</strong> - Коли першого члена групи вбито або виведено з бою</li>
                            <li><strong>Програють</strong> - Група починає очевидно програвати або шанси на перемогу зменшуються</li>
                            <li><strong>Жах</strong> - Стикаються з жахливою магією, страхітливою різаниною або значно сильнішим ворогом</li>
                            <li><strong>Цивільні</strong> - Цивільні вперше стикаються з реальною фізичною загрозою</li>
                            <li><strong>Засідка</strong> - Недисципліновані цілі можуть перевіряти при несподіваній засідці (на розсуд ГМ)</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Наслідки Провалу</h5>
                        <ul class="small ps-3 mb-0">
                            <li><strong>Цивільні:</strong> Божевільна втеча, кидають все</li>
                            <li><strong>Треновані бійці:</strong> Бойовий відступ, намагаються втекти з товаришами</li>
                            <li><strong>Якщо втеча неможлива:</strong> Здаються, впадають у відчай, або б'ються з люттю</li>
                        </ul>
                    </div>

                    <p class="small text-body-secondary mb-0">
                        <strong>Типова Мораль:</strong> 2-5 боягузи, 6-7 звичайні, 8-9 хоробрі, 10-11 безстрашні, 12 незламні. ПГ ніколи не кидають.
                    </p>
                </div>
            </div>
        </div>

        <!-- Instinct Checks -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Перевірки Інстинкту</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="1d10" @click="roll()" :class="{ 'rolled': rolled }" title="Натисніть для кидка" x-text="displayText">1к10</span> &le; Інстинкт = <span class="modifier-negative">Провал</span>
                        </div>
                        <p>При провалі: НІП діє імпульсивно, короткозоро, інстинктивно.</p>
                    </div>

                    <div class="action-item">
                        <h5>Коли Кидати</h5>
                        <ul class="trigger-list">
                            <li><strong>Раунд 2+</strong> - Другий раунд бою для недисциплінованих бійців</li>
                            <li><strong>Після Моралі</strong> - Істота щойно робила перевірку Моралі</li>
                            <li><strong>Збентеження</strong> - Ворог зробив щось заплутане або дезорієнтуюче</li>
                            <li><strong>Провокація</strong> - Ворог розлютив або безпосередньо залякав істоту</li>
                            <li><strong>Спокуса</strong> - Представлено щось бажане (їжа, гроші тощо)</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Приклади Провалу</h5>
                        <ul class="small ps-3 mb-0">
                            <li>Сліпо атакує неоптимальні цілі</li>
                            <li>Використовує беззбройні атаки замість зброї в руці</li>
                            <li>Спрямовує закляття/постріли на менш важливі цілі</li>
                            <li>Женеться за кинутою приманкою замість бою</li>
                        </ul>
                    </div>

                    <p class="small text-body-secondary mb-0">
                        <strong>Типовий Інстинкт:</strong> 5+ звірі/цивільні, 3-4 ветерани, 1-2 загартовані, 0 найхолоднокровніші вбивці. ПГ ніколи не кидають. Опціонально.
                    </p>
                </div>
            </div>
        </div>

        <!-- Running NPC Combat & Fleeing -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Керування НІПами &amp; Втеча</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <h5>Поради для Бою НІПів</h5>
                        <ul class="small ps-3 mb-0">
                            <li>НІПи не б'ються до смерті, якщо не змушені</li>
                            <li>Перевіряйте Мораль, коли справи йдуть погано</li>
                            <li>Перевіряйте Інстинкт при збентеженні або провокації</li>
                            <li>Дозволяйте НІПам робити тактичні помилки - вони не ідеальні</li>
                            <li>Після провалу Моралі сторона не битиметься з тими ж ворогами, доки ситуація не зміниться</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Поради для ГМ</h5>
                        <ul class="small ps-3 mb-0">
                            <li>Будьте поблажливі щодо втечі ПГ</li>
                            <li>Більшість переслідувачів не будуть невпинно наполегливими</li>
                            <li>Втеча - життєздатний варіант, а не привід померти втомленими</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chases -->
        <div class="col-12 col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Погоні &amp; Переслідування</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Foot Chase -->
                        <div class="col-md-6">
                            <h6>Пішки</h6>
                            <ol class="small text-body-secondary ps-3 mb-3">
                                <li><strong>Темп втечі:</strong> Найкращий СПР/АТЛЕТИКА або СТА/АТЛЕТИКА у групі втікачів = <strong>Темп</strong></li>
                                <li><strong>Помічники:</strong> Інші втікачі заважають переслідуванню (перевірка навички або рішення ГМ). Успіх = <span class="modifier-positive">+1</span> до Темпу кожен, макс <span class="modifier-positive">+3</span></li>
                                <li><strong>Переслідувачі кидають:</strong> Один кидок СПР/АТЛЕТИКА або СТА/АТЛЕТИКА з модифікаторами</li>
                                <li><strong>Результат:</strong> Перевищує Темп = <span class="modifier-negative">спіймано</span>. Рівно або менше = <span class="modifier-positive">втекли</span></li>
                            </ol>

                            <h6>Модифікатори Темпу Пішки</h6>
                            <div class="modifier-table">
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Без фори взагалі</span>
                                    <span class="mod-table-value modifier-positive">+2</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Один раунд фори</span>
                                    <span class="mod-table-value modifier-positive">+1</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">&lt;1 хв фори</span>
                                    <span class="mod-table-value">+0</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">&gt;1 хв фори</span>
                                    <span class="mod-table-value modifier-negative">-2</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Переслідувачів більше</span>
                                    <span class="mod-table-value modifier-negative">-1</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Знання місцевості</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-2</span> до <span class="modifier-positive">+2</span></span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Млявість / Лють</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-1</span> / <span class="modifier-positive">+1</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Mounted Chase -->
                        <div class="col-md-6">
                            <h6>Верхи</h6>
                            <ol class="small text-body-secondary ps-3 mb-3">
                                <li><strong>Темп втечі:</strong> Втікач кидає СПР/ЇЗДА = <strong>Темп</strong></li>
                                <li><strong>Кожен переслідувач кидає:</strong> СПР/ЇЗДА з модифікаторами</li>
                                <li><strong>Результат:</strong> Рівно або більше Темпу = <span class="modifier-negative">наздогнав</span>. Менше = <span class="modifier-positive">відстав &amp; загубив</span></li>
                            </ol>
                            <p class="small text-body-secondary mb-3">
                                <strong>Примітка:</strong> Пішоходи не можуть наздогнати верхових у короткочасних погонях.
                            </p>

                            <h6>Модифікатори Темпу Верхи</h6>
                            <div class="modifier-table">
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Не бачить втікача напряму</span>
                                    <span class="mod-table-value modifier-negative">-2</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Переслідувач летить, втікач ні</span>
                                    <span class="mod-table-value modifier-positive">+3</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Втікач летить, переслідувач ні</span>
                                    <span class="mod-table-value modifier-negative">-3</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Спостерігач передає позицію</span>
                                    <span class="mod-table-value modifier-positive">+1</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Знання місцевості</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-2</span> до <span class="modifier-positive">+2</span></span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Млявість / Лють</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-1</span> / <span class="modifier-positive">+1</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Alpine.js Components (uses $store.dice from base.html) -->
<script>
    // Register Alpine components BEFORE Alpine loads
    document.addEventListener('alpine:init', () => {
        // Turn tracker component
        Alpine.data('turnTracker', () => ({
            turns: 0,
            get time() {
                const mins = this.turns * 10;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                if (h > 0 && m > 0) return `${h}г${m}хв`;
                if (h > 0) return `${h}г`;
                if (m > 0) return `${m}хв`;
                return '';
            }
        }));

        // Rollable dice component - uses $store.dice.roll() from base.html
        Alpine.data('rollable', () => ({
            notation: '',
            displayText: '',
            rolled: false,
            timeout: null,
            clickHandler: null,

            init() {
                this.notation = this.$el.dataset.notation || this.$el.textContent.trim();
                this.displayText = this.notation;
            },

            roll() {
                this.reset();
                const r = Alpine.store('dice').roll(this.notation);
                if (r) {
                    this.displayText = `${r.total} [${r.rolls.join(',')}]`;
                    this.rolled = true;

                    // Reset after 3 seconds
                    this.timeout = setTimeout(() => this.reset(), 3000);

                    // Reset on click anywhere else
                    this.clickHandler = (e) => {
                        if (e.target !== this.$el) this.reset();
                    };
                    setTimeout(() => document.addEventListener('click', this.clickHandler, { once: true }), 10);
                }
            },

            reset() {
                if (this.timeout) clearTimeout(this.timeout);
                if (this.clickHandler) document.removeEventListener('click', this.clickHandler);
                this.displayText = this.notation;
                this.rolled = false;
                this.timeout = null;
                this.clickHandler = null;
            }
        }));
    });
</script>

<script>
(function() {
    const hdInput = document.getElementById('total_hd');
    const attacksInput = document.getElementById('total_attacks');
    const pcsInput = document.getElementById('num_pcs');
    const levelsInput = document.getElementById('total_pc_levels');

    // HD and attacks are independent - no constraints between them

    // Party: PCs up -> levels bumps up; levels down -> PCs drops
    pcsInput.addEventListener('input', function() {
        const pcs = parseInt(this.value) || 1;
        const levels = parseInt(levelsInput.value) || 1;
        if (levels < pcs) levelsInput.value = pcs;
    });

    levelsInput.addEventListener('input', function() {
        const pcs = parseInt(pcsInput.value) || 1;
        const levels = parseInt(this.value) || 1;
        if (levels < pcs) pcsInput.value = levels;
    });
})();
</script>
{% endblock %}
