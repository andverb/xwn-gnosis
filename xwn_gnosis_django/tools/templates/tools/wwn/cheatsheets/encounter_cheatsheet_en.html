{% extends "tools/wwn/cheatsheets/cheatsheet_base.html" %}

{% block title %}Encounter Cheatsheet - Gnosis{% endblock %}

{% block cheatsheet_styles %}
<style>
    /* Compact table */
    .compact-table {
        width: 100%;
        font-size: 0.85rem;
        margin: 0.5rem 0;
    }
    .compact-table th {
        font-weight: 600;
        color: var(--bs-secondary-color);
        font-size: 0.75rem;
        text-transform: uppercase;
    }
    .compact-table td:first-child {
        font-weight: bold;
        color: var(--bs-primary);
        width: 3rem;
        text-align: center;
    }
    .compact-table td:last-child {
        color: var(--bs-secondary-color);
    }

    /* Turn Tracker */
    .turn-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.5rem;
    }
    .turn-table th,
    .turn-table td {
        padding: 0.25rem;
        text-align: center;
        border: 1px solid var(--bs-border-color);
    }
    .turn-table th {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        background: var(--bs-tertiary-bg);
    }
    .turn-table .row-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        background: var(--bs-tertiary-bg);
        width: 3rem;
    }
    .turn-table input[type="checkbox"] {
        margin: 0;
        width: 1.1rem;
        height: 1.1rem;
    }
    .turn-legend {
        display: flex;
        gap: 1rem;
        align-items: center;
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
    }
    .turn-table .reset-btn {
        width: 1.5rem;
        height: 1.5rem;
        padding: 0;
        font-size: 0.9rem;
        line-height: 1;
        margin: 0;
    }

    /* Formula box (centered, monospace - encounter specific) */
    .formula-box {
        font-family: monospace;
        font-size: 1rem;
        text-align: center;
        padding: 0.75rem;
    }

    /* Variant rule styling */
    .variant {
        color: #6f42c1;
        cursor: help;
        border-bottom: 1px dotted #6f42c1;
    }
    [data-bs-theme="dark"] .variant {
        color: #b794f6;
        border-bottom-color: #b794f6;
    }

    /* Trigger list */
    .trigger-list {
        font-size: 0.85rem;
        list-style: none;
        padding-left: 0;
    }
    .trigger-list li {
        margin-bottom: 0.4rem;
        padding-left: 0.75rem;
        border-left: 3px solid var(--bs-primary);
    }

    /* Reaction table with color coding */
    .reaction-table {
        font-size: 0.85rem;
        width: 100%;
    }
    .reaction-row {
        display: flex;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.25rem;
        margin-bottom: 0.25rem;
    }
    .reaction-row:last-child {
        margin-bottom: 0;
    }
    .reaction-score {
        font-weight: bold;
        min-width: 2.5rem;
    }
    .reaction-hostile { background: rgba(220, 53, 69, 0.2); color: var(--bs-danger); }
    .reaction-unfriendly { background: rgba(253, 126, 20, 0.15); color: #fd7e14; }
    .reaction-neutral { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
    .reaction-friendly { background: rgba(25, 135, 84, 0.15); color: var(--bs-success); }
    .reaction-helpful { background: rgba(25, 135, 84, 0.25); color: var(--bs-success); }

    /* Calculator specific styles */
    .calculator-sides {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .calculator-side {
        background: var(--bs-tertiary-bg);
        padding: 0.75rem;
        border-radius: 0.5rem;
    }
    .calculator-side h5 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        text-align: center;
    }
    .side-foes h5 { color: var(--bs-danger); }
    .side-party h5 { color: var(--bs-success); }
    .calculator-side .field-row {
        display: flex;
        gap: 0.5rem;
    }
    .calculator-side .field-group {
        flex: 1;
        text-align: center;
    }
    .calculator-side input {
        margin-bottom: 0;
        padding: 0.4rem;
        text-align: center;
        width: 100%;
    }
    .calculator-side .field-label {
        font-size: 0.7rem;
        color: var(--bs-secondary-color);
        display: block;
        margin-top: 0.2rem;
    }
    .calculator-result {
        background: var(--bs-tertiary-bg);
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    .calculator-result .scores {
        display: flex;
        justify-content: space-around;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }
    .calculator-result .score-box {
        text-align: center;
    }
    .calculator-result .score-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--bs-primary);
    }
    .calculator-result .score-label {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
    }
    .calculator-result .verdict {
        font-weight: bold;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }
    .verdict-rout { background: #dc3545; color: white; }
    .verdict-deadly { background: #fd7e14; color: white; }
    .verdict-hard { background: #ffc107; color: #212529; }
    .verdict-fair { background: #198754; color: white; }
    .verdict-easy { background: #0d6efd; color: white; }
    .challenge-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.4rem;
        margin-top: 0.75rem;
    }
    .challenge-legend .legend-item {
        font-size: 0.7rem;
        font-weight: bold;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block cheatsheet_content %}
<div class="container">
    <div class="text-center mb-4">
        <h1 class="h2">Encounter Cheatsheet</h1>
    </div>

    <div class="row g-3">

        <!-- Ruin Turns & Encounters -->
        <div class="col-12 col-lg-4">
            <div class="card h-100" x-data="turnTracker">
                <div class="card-header">
                    <h5 class="card-title mb-0">Ruin Turns &amp; Encounters</h5>
                </div>
                <div class="card-body">
                    <table class="turn-table">
                        <thead>
                            <tr>
                                <th><button class="btn btn-sm btn-outline-secondary reset-btn" @click="turns = 0" title="Reset">&#8634;</button></th>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns < 6" x-text="time"></span>
                                    <span x-show="turns >= 6">&#128293;</span>
                                </td>
                                <template x-for="i in 6" :key="i">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i" @change="turns = turns >= i ? i - 1 : i"></td>
                                </template>
                            </tr>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns >= 6 && turns < 12" x-text="time"></span>
                                    <span x-show="turns >= 12">&#128293;</span>
                                </td>
                                <template x-for="i in 6" :key="i + 6">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i + 6" @change="turns = turns >= i + 6 ? i + 5 : i + 6"></td>
                                </template>
                            </tr>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns >= 12 && turns < 18" x-text="time"></span>
                                    <span x-show="turns >= 18">&#128293;</span>
                                </td>
                                <template x-for="i in 6" :key="i + 12">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i + 12" @change="turns = turns >= i + 12 ? i + 11 : i + 12"></td>
                                </template>
                            </tr>
                            <tr>
                                <td class="row-label">
                                    <span x-show="turns >= 18 && turns < 24" x-text="time"></span>
                                    <span x-show="turns >= 24">&#128293;&#127982;</span>
                                </td>
                                <template x-for="i in 6" :key="i + 18">
                                    <td><input type="checkbox" class="form-check-input" :checked="turns >= i + 18" @change="turns = turns >= i + 18 ? i + 17 : i + 18"></td>
                                </template>
                            </tr>
                        </tbody>
                    </table>

                    <div class="turn-legend">
                        <span>&#128293; torch (6 turns / 1h)</span>
                        <span>&#127982; lantern (24 turns / 4h)</span>
                    </div>

                    <div class="small text-body-secondary mt-2 mb-3">
                        <p class="mb-1"><strong>1 turn = 10 minutes:</strong></p>
                        <ul class="mb-0">
                            <li>Move room to room</li>
                            <li>Pick lock</li>
                            <li>Disarm trap</li>
                            <li>Fight</li>
                            <li>First aid &amp; loot</li>
                            <li>Search room</li>
                            <li>Parley</li>
                            <li>Jury-rig device</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Encounter Check</h5>
                        <ul class="mb-0">
                            <li>Roll <span class="dice" x-data="rollable" data-notation="1d6" @click="roll()" :class="{ 'rolled': rolled }" title="Click to roll" x-text="displayText">1d6</span> — encounter on <strong>1</strong> (on <strong>1–2</strong> in dangerous areas)</li>
                            <li>Distance: room — nearest entrance; corridor — <span class="dice" x-data="rollable" data-notation="1d8" @click="roll()" :class="{ 'rolled': rolled }" title="Click to roll" x-text="displayText">1d8</span> × 10'</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Check Frequency</h5>
                        <table class="table table-sm compact-table">
                            <thead>
                                <tr><th>Turns</th><th>Location Type</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>1</td><td>Alerted site, organized defenders</td></tr>
                                <tr><td>2</td><td>Unalert site, organized defenders</td></tr>
                                <tr><td>3</td><td>No organized or active defense</td></tr>
                                <tr><td>4</td><td>Very few mobile inhabitants</td></tr>
                                <tr><td>6</td><td>Abandoned or disused area</td></tr>
                                <tr><td>-</td><td>Hidden chamber unknown to natives</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reaction Rolls -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Reaction Rolls</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="2d6" @click="roll()" :class="{ 'rolled': rolled }" title="Click to roll" x-text="displayText">2d6</span> + Cha mod (if PCs can greet)
                        </div>
                        <p>Roll for every encounter unless bloodshed is inevitable. Clue PCs into results before they act.</p>
                    </div>

                    <div class="action-item">
                        <div class="reaction-table">
                            <div class="reaction-row reaction-hostile">
                                <span class="reaction-score">2-</span>
                                <span class="reaction-desc">Hostile as the situation allows</span>
                            </div>
                            <div class="reaction-row reaction-unfriendly">
                                <span class="reaction-score">3-5</span>
                                <span class="reaction-desc">More unfriendly than expected</span>
                            </div>
                            <div class="reaction-row reaction-neutral">
                                <span class="reaction-score">6-8</span>
                                <span class="reaction-desc">Predictably hostile or friendly</span>
                            </div>
                            <div class="reaction-row reaction-friendly">
                                <span class="reaction-score">9-11</span>
                                <span class="reaction-desc">More friendly than expected</span>
                            </div>
                            <div class="reaction-row reaction-helpful">
                                <span class="reaction-score">12+</span>
                                <span class="reaction-desc">As friendly and helpful as possible</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-item">
                        <h5>Peaceful Reactions</h5>
                        <p class="small text-body-secondary mb-2">What "friendly" means for hostile groups:</p>
                        <ul class="small ps-3">
                            <li><strong>Demand a bribe</strong> - Money, gear, food, praise; haggling possible</li>
                            <li><strong>Back off</strong> - Keep distance, let groups pass; may report later</li>
                            <li><strong>Ask for favors</strong> - Enemy killed, task done; offer to ignore PCs in return</li>
                            <li><strong>Offer tribute</strong> - Wealth, info, services to be left alone</li>
                            <li><strong>Willingly socialize</strong> - Lonely, mistaken identity, or just chatty</li>
                        </ul>
                    </div>

                    <p class="small text-body-secondary mb-0">
                        <strong>Remember:</strong> Reaction rolls are just the start. Clever words, gifts, or insults can shift attitudes.
                    </p>
                </div>
            </div>
        </div>

        <!-- Surprise & Initiative -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Surprise &amp; Initiative</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <h5>Surprise</h5>
                        <p>If GM decides surprise is possible, roll <strong>Wis/Notice</strong> vs <strong>Dex/Sneak</strong>. If attackers win, they act full round before initiative is rolled.</p>
                        <p class="small text-body-secondary">Ambush might provoke Morale check from unmilitary or undisciplined targets (GM discretion).</p>
                    </div>

                    <div class="action-item">
                        <h5>Initiative</h5>
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="1d8" @click="roll()" :class="{ 'rolled': rolled }" title="Click to roll" x-text="displayText">1d8</span> + highest Dex <span class="variant" title="Variant rule">(or Int)</span> mod
                        </div>
                        <p>Each side rolls. Winning side acts first in any order, then the other. NPCs usually have no modifier unless quick. PCs win ties.</p>
                        <p class="small text-body-secondary mt-2"><span class="variant" title="Individual Initiative variant">Variant:</span> Each participant rolls their own initiative and acts in order.</p>
                    </div>

                    <div class="action-item">
                        <h5>Fleeing &amp; Escape</h5>
                        <p>If foes pursue (many don't), escapee with best <strong>Dex/Exert</strong> rolls vs fastest pursuer. Success = ~1 turn to safety.</p>
                        <div class="modifier-table mt-2">
                            <div class="mod-table-row">
                                <span class="mod-table-desc">Escapees outnumber pursuers</span>
                                <span class="mod-table-value modifier-positive">+1</span>
                            </div>
                            <div class="mod-table-row">
                                <span class="mod-table-desc">Good escape plan</span>
                                <span class="mod-table-value modifier-positive">+1</span>
                            </div>
                            <div class="mod-table-row">
                                <span class="mod-table-desc">Slowed by slowest member</span>
                                <span class="mod-table-value modifier-negative">-2</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenge Calculator -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Challenge Calculator</h5>
                </div>
                <div class="card-body">
                    <form id="challenge-form"
                          hx-post="{% url 'tools:calculate_challenge' %}"
                          hx-target="#calculator-result"
                          hx-trigger="load, input delay:150ms, submit"
                          hx-swap="innerHTML"
                          autocomplete="off">
                        <div class="calculator-sides">
                            <div class="calculator-side side-foes">
                                <h5>Foes</h5>
                                <div class="field-row">
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="total_hd" name="total_hd" min="1" value="1">
                                        <span class="field-label">HD (total)</span>
                                    </div>
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="total_attacks" name="total_attacks" min="1" value="1">
                                        <span class="field-label">Attacks (total)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="calculator-side side-party">
                                <h5>Party</h5>
                                <div class="field-row">
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="num_pcs" name="num_pcs" min="1" value="4">
                                        <span class="field-label"># of PCs</span>
                                    </div>
                                    <div class="field-group">
                                        <input type="number" class="form-control form-control-sm" id="total_pc_levels" name="total_pc_levels" min="1" value="4">
                                        <span class="field-label">Levels (total)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div id="calculator-result">
                        {% include "tools/wwn/cheatsheets/partials/_challenge_result_en.html" %}
                    </div>

                    <div class="challenge-legend">
                        <span class="legend-item verdict-rout">&gt;4x Rout</span>
                        <span class="legend-item verdict-deadly">~2x Deadly</span>
                        <span class="legend-item verdict-hard">&gt;1x Hard</span>
                        <span class="legend-item verdict-fair">&le;1x Fair</span>
                        <span class="legend-item verdict-easy">&lt;1/2x Easy</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Morale Checks -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Morale Checks</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="2d6" @click="roll()" :class="{ 'rolled': rolled }" title="Click to roll" x-text="displayText">2d6</span> &gt; ML = <span class="modifier-negative">Fail</span>
                        </div>
                        <p>On failure: NPC retreats, surrenders, or seeks to escape.</p>
                    </div>

                    <div class="action-item">
                        <h5>When to Roll</h5>
                        <ul class="trigger-list">
                            <li><strong>First casualty</strong> - When first member of a group is killed or incapacitated</li>
                            <li><strong>Losing badly</strong> - Group starts to visibly lose or odds of victory shrink</li>
                            <li><strong>Terror</strong> - Facing terrifying magic, horrendous slaughter, or vastly superior foe</li>
                            <li><strong>Non-combatant</strong> - Civilian first faced with serious physical harm</li>
                            <li><strong>Ambush</strong> - Undisciplined targets may check when ambushed (GM discretion)</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Failure Consequences</h5>
                        <ul class="small ps-3 mb-0">
                            <li><strong>Non-combatants:</strong> Flee madly, drop everything</li>
                            <li><strong>Trained fighters:</strong> Fighting withdrawal, try to escape with comrades</li>
                            <li><strong>If escape impossible:</strong> Surrender, collapse in despair, or fight with frenzy</li>
                        </ul>
                    </div>

                    <p class="small text-body-secondary mb-0">
                        <strong>Typical ML:</strong> 2-5 cowardly, 6-7 average, 8-9 brave, 10-11 fearless, 12 unbreakable. PCs never check.
                    </p>
                </div>
            </div>
        </div>

        <!-- Instinct Checks -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Instinct Checks</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <div class="formula-box">
                            <span class="dice" x-data="rollable" data-notation="1d10" @click="roll()" :class="{ 'rolled': rolled }" title="Click to roll" x-text="displayText">1d10</span> &le; Inst = <span class="modifier-negative">Fail</span>
                        </div>
                        <p>On failure: NPC acts impulsively, short-sightedly, instinctually.</p>
                    </div>

                    <div class="action-item">
                        <h5>When to Roll</h5>
                        <ul class="trigger-list">
                            <li><strong>Round 2+</strong> - Second round of combat for mobs and undisciplined fighters</li>
                            <li><strong>After Morale</strong> - Creature just had to make a Morale check</li>
                            <li><strong>Confusion</strong> - Enemy did something confusing or disorienting</li>
                            <li><strong>Provoked</strong> - Enemy enraged or directly intimidated the creature</li>
                            <li><strong>Temptation</strong> - Presented with something it desires (food, money, etc.)</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>Failure Examples</h5>
                        <ul class="small ps-3 mb-0">
                            <li>Attack sub-optimal targets blindly</li>
                            <li>Use unarmed attacks instead of weapon in hand</li>
                            <li>Aim spells/shots at targets of lesser importance</li>
                            <li>Chase after dropped bait instead of fighting</li>
                        </ul>
                    </div>

                    <p class="small text-body-secondary mb-0">
                        <strong>Typical Inst:</strong> 5+ beasts/civilians, 3-4 veterans, 1-2 hardened, 0 coldest killers. PCs never check. Optional.
                    </p>
                </div>
            </div>
        </div>

        <!-- Running NPC Combat & Fleeing -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Running NPCs &amp; Fleeing</h5>
                </div>
                <div class="card-body">
                    <div class="action-item">
                        <h5>NPC Combat Tips</h5>
                        <ul class="small ps-3 mb-0">
                            <li>NPCs won't fight to the death unless they must</li>
                            <li>Check Morale when things go badly</li>
                            <li>Check Instinct when confused or provoked</li>
                            <li>Let NPCs make tactical errors - they're not perfect</li>
                            <li>Once Morale fails, side won't fight those foes until courage recovered</li>
                        </ul>
                    </div>

                    <div class="action-item">
                        <h5>GM Guidance</h5>
                        <ul class="small ps-3 mb-0">
                            <li>Be charitable about letting PCs run away</li>
                            <li>Most pursuers won't be relentlessly persistent</li>
                            <li>Running away is a viable option, not an excuse to die tired</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chases -->
        <div class="col-12 col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Chases &amp; Pursuit</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Foot Chase -->
                        <div class="col-md-6">
                            <h6>Foot Chase</h6>
                            <ol class="small text-body-secondary ps-3 mb-3">
                                <li><strong>Fleeing pace:</strong> Best Dex/Exert or Con/Exert in fleeing group rolls = <strong>Pace</strong></li>
                                <li><strong>Helpers:</strong> Other fleeing members hinder pursuit (skill check or GM judgment). Success = <span class="modifier-positive">+1</span> to Pace each, max <span class="modifier-positive">+3</span></li>
                                <li><strong>Pursuers roll:</strong> Single Dex/Exert or Con/Exert check with modifiers</li>
                                <li><strong>Result:</strong> Beat Pace = <span class="modifier-negative">caught</span>. Tie or less = <span class="modifier-positive">escaped</span></li>
                            </ol>

                            <h6>Foot Chase Pace Modifiers</h6>
                            <div class="modifier-table">
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">No head start at all</span>
                                    <span class="mod-table-value modifier-positive">+2</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">One round head start</span>
                                    <span class="mod-table-value modifier-positive">+1</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">&lt;1 minute head start</span>
                                    <span class="mod-table-value">+0</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">&gt;1 minute head start</span>
                                    <span class="mod-table-value modifier-negative">-2</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">More pursuers than pursued</span>
                                    <span class="mod-table-value modifier-negative">-1</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Terrain knowledge</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-2</span> to <span class="modifier-positive">+2</span></span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Half-hearted / Enraged</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-1</span> / <span class="modifier-positive">+1</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Mounted Chase -->
                        <div class="col-md-6">
                            <h6>Mounted Chase</h6>
                            <ol class="small text-body-secondary ps-3 mb-3">
                                <li><strong>Fleeing pace:</strong> Fleeing rider rolls Dex/Ride = <strong>Pace</strong></li>
                                <li><strong>Each pursuer rolls:</strong> Dex/Ride with modifiers</li>
                                <li><strong>Result:</strong> Meet or exceed Pace = <span class="modifier-negative">catch up</span>. Fail = <span class="modifier-positive">fall behind &amp; lost</span></li>
                            </ol>
                            <p class="small text-body-secondary mb-3">
                                <strong>Note:</strong> Unmounted pursuers cannot catch mounted evaders in short-term chases.
                            </p>

                            <h6>Mounted Chase Pace Modifiers</h6>
                            <div class="modifier-table">
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Can't directly see pursued</span>
                                    <span class="mod-table-value modifier-negative">-2</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Pursuer flying, pursued not</span>
                                    <span class="mod-table-value modifier-positive">+3</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Pursued flying, pursuer not</span>
                                    <span class="mod-table-value modifier-negative">-3</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Spotter relaying position</span>
                                    <span class="mod-table-value modifier-positive">+1</span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Terrain knowledge</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-2</span> to <span class="modifier-positive">+2</span></span>
                                </div>
                                <div class="mod-table-row">
                                    <span class="mod-table-desc">Half-hearted / Enraged</span>
                                    <span class="mod-table-value"><span class="modifier-negative">-1</span> / <span class="modifier-positive">+1</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Alpine.js Components (uses $store.dice from base.html) -->
<script>
    // Register Alpine components BEFORE Alpine loads
    document.addEventListener('alpine:init', () => {
        // Turn tracker component
        Alpine.data('turnTracker', () => ({
            turns: 0,
            get time() {
                const mins = this.turns * 10;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                if (h > 0 && m > 0) return `${h}h${m}m`;
                if (h > 0) return `${h}h`;
                if (m > 0) return `${m}m`;
                return '';
            }
        }));

        // Rollable dice component - uses $store.dice.roll() from base.html
        Alpine.data('rollable', () => ({
            notation: '',
            displayText: '',
            rolled: false,
            timeout: null,
            clickHandler: null,

            init() {
                this.notation = this.$el.dataset.notation || this.$el.textContent.trim();
                this.displayText = this.notation;
            },

            roll() {
                this.reset();
                const r = Alpine.store('dice').roll(this.notation);
                if (r) {
                    this.displayText = `${r.total} [${r.rolls.join(',')}]`;
                    this.rolled = true;

                    // Reset after 3 seconds
                    this.timeout = setTimeout(() => this.reset(), 3000);

                    // Reset on click anywhere else
                    this.clickHandler = (e) => {
                        if (e.target !== this.$el) this.reset();
                    };
                    setTimeout(() => document.addEventListener('click', this.clickHandler, { once: true }), 10);
                }
            },

            reset() {
                if (this.timeout) clearTimeout(this.timeout);
                if (this.clickHandler) document.removeEventListener('click', this.clickHandler);
                this.displayText = this.notation;
                this.rolled = false;
                this.timeout = null;
                this.clickHandler = null;
            }
        }));
    });
</script>

<script>
(function() {
    const hdInput = document.getElementById('total_hd');
    const attacksInput = document.getElementById('total_attacks');
    const pcsInput = document.getElementById('num_pcs');
    const levelsInput = document.getElementById('total_pc_levels');

    // HD and attacks are independent - no constraints between them

    // Party: PCs up -> levels bumps up; levels down -> PCs drops
    pcsInput.addEventListener('input', function() {
        const pcs = parseInt(this.value) || 1;
        const levels = parseInt(levelsInput.value) || 1;
        if (levels < pcs) levelsInput.value = pcs;
    });

    levelsInput.addEventListener('input', function() {
        const pcs = parseInt(pcsInput.value) || 1;
        const levels = parseInt(this.value) || 1;
        if (levels < pcs) pcsInput.value = levels;
    });
})();
</script>
{% endblock %}
